<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Ensuring spatial consistency: countries, states, and coordinates • RuHere</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="2. Ensuring spatial consistency: countries, states, and coordinates">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RuHere</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html" aria-label="Home"><span class="fa fas fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fas fa-code"></span> Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/obtaining_data.html">1. Obtaining and preparing occurrence data</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_consistency.html">2. Ensuring spatial consistency</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records.html">3. Flagging Records Using Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records_species_list.html">4. Flagging Records with Specialists' Information</a></li>
    <li><a class="dropdown-item" href="../articles/sampling_bias.html">5. Reducing sampling bias</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav"></ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>2. Ensuring spatial consistency: countries, states, and coordinates</h1>
            
      

      <div class="d-none name"><code>spatial_consistency.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Even after initial formatting, species occurrence data often retain
spatial inconsistencies that can compromise subsequent analyses. Common
issues include varying spellings for the same country (i.e., Brasil,
Brazil or BR) or state name, missing administrative information, or
coordinates that fall outside the political-administrative jurisdiction
assigned to the record. This vignette demonstrates how to ensure the
spatial consistency of your occurrence records by addressing name
standardization, data imputation, verification, and correction.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load RuHere package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wevertonbio.github.io/RuHere/">RuHere</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="overview-of-the-functions">Overview of the functions:<a class="anchor" aria-label="anchor" href="#overview-of-the-functions"></a>
</h2>
<ul>
<li>
<code><a href="../reference/standardize_countries.html">standardize_countries()</a></code>: standardizes country names and
codes.</li>
<li>
<code><a href="../reference/standardize_states.html">standardize_states()</a></code>: standardizes state/province names
and codes.</li>
<li>
<code><a href="../reference/country_from_coords.html">country_from_coords()</a></code>: extracts the country name from
geographic coordinates.</li>
<li>
<code><a href="../reference/states_from_coords.html">states_from_coords()</a></code>: extracts the state/province name
from geographic coordinates.</li>
<li>
<code><a href="../reference/check_countries.html">check_countries()</a></code>: verifies if coordinates fall within
the boundaries of the assigned country.</li>
<li>
<code><a href="../reference/check_states.html">check_states()</a></code>: verifies if coordinates fall within the
boundaries of the assigned state/province.</li>
<li>
<code><a href="../reference/fix_countries.html">fix_countries()</a></code>: identifies and corrects common
coordinate errors based on country jurisdiction.</li>
</ul>
</div>
<div class="section level2">
<h2 id="standardizing-country-and-state-names">Standardizing country and state names<a class="anchor" aria-label="anchor" href="#standardizing-country-and-state-names"></a>
</h2>
<p>Standardizing administrative names is the first step to ensure that
all spelling variations and codes are mapped to a single accepted
format.</p>
<div class="section level3">
<h3 id="occurrence-data">Occurrence data<a class="anchor" aria-label="anchor" href="#occurrence-data"></a>
</h3>
<p>At this stage, you should have an occurrence dataset that has been
standardized using the <code><a href="../reference/format_columns.html">format_columns()</a></code> function and merged
with <code><a href="../reference/bind_here.html">bind_here()</a></code>. For additional details on this workflow,
see the vignette <em>“1. Obtaining and preparing species occurrence
data”</em>.</p>
<p>To illustrate how the function works, we use the example occurrence
dataset included in the package, which contains records for three
species: the Paraná pine (<em>Araucaria angustifolia</em>), the azure
jay (<em>Cyanocorax caeruleus</em>), and the yellow trumpet tree
(<em>Handroanthus albus</em>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loading package occurrence data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"occurrences"</span>, package <span class="op">=</span> <span class="st">"RuHere"</span><span class="op">)</span></span>
<span><span class="co"># Number of records per species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">occurrences</span><span class="op">$</span><span class="va">species</span><span class="op">)</span></span>
<span><span class="co">#&gt; Araucaria angustifolia     Cyanocorax caeruleus    Handroanthus serratifolius </span></span>
<span><span class="co">#&gt;                  1444                      2302                          2363 </span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="standardizing-countries-standardize_countries">Standardizing countries (<code>standardize_countries</code>)<a class="anchor" aria-label="anchor" href="#standardizing-countries-standardize_countries"></a>
</h3>
<p>This function harmonizes country names using exact matching and fuzzy
matching to correct typos and variations. It compares the input against
a comprehensive dictionary of names and codes provided in
<code>rnaturalearthdata::map_units110()</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standardize country names</span></span>
<span><span class="va">occ_country_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standardize_countries.html">standardize_countries</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occurrences</span>,</span>
<span>    country_column <span class="op">=</span> <span class="st">"country"</span>,</span>
<span>    max_distance <span class="op">=</span> <span class="fl">0.1</span>,      <span class="co"># Maximum error distance for fuzzy matching</span></span>
<span>    lookup_na_country <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Try to extract country from coords if value is </span></span>
<span>    <span class="co"># NA using the country_from_coords() function internally</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This function returns a list with two elements:</p>
<ul>
<li><p><code>$occ</code>: the original data frame with two new columns:
<code>country_suggested</code> (the standardized or corrected country
name) and <code>country_source</code> (whether the suggested country
came from the original metadata or was imputed from
coordinates).</p></li>
<li><p><code>$report</code>: a summary of the corrections made, showing
the original name and the suggested/standardized name.</p></li>
</ul>
<p>Below are the first few rows of the modified data frame and the
standardization report:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Printing first rows and columns</span></span>
<span><span class="va">occ_country_std</span><span class="op">$</span><span class="va">occ</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="co">#&gt;   country country_suggested country_source  record_id               species</span></span>
<span><span class="co">#&gt; 1      AR         argentina       metadata  gbif_5516  Araucaria angustifolia</span></span>
<span><span class="co">#&gt; 2      AR         argentina       metadata gbif_15849  Araucaria angustifolia</span></span>
<span><span class="co">#&gt; 3      AR         argentina       metadata  gbif_4935  Araucaria angustifolia</span></span>
<span></span>
<span><span class="va">occ_country_std</span><span class="op">$</span><span class="va">report</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      country country_suggested</span></span>
<span><span class="co">#&gt; 1  argentina         argentina</span></span>
<span><span class="co">#&gt; 2    bolivia           bolivia</span></span>
<span><span class="co">#&gt; 3     brasil            brazil</span></span>
<span><span class="co">#&gt; 4         UY           uruguay</span></span>
<span><span class="co">#&gt; 5         PT          portugal</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="standardizing-states-standardize_states">Standardizing states (<code>standardize_states</code>)<a class="anchor" aria-label="anchor" href="#standardizing-states-standardize_states"></a>
</h3>
<p>Similarly, this function standardizes state or province names. It
uses the previously standardized country column
(<code>country_suggested</code>) to disambiguate states that might share
names across different countries, using as reference the names and
postal codes provided in <code>rnaturalearthdata::states50()</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standardize state names</span></span>
<span><span class="va">occ_state_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standardize_states.html">standardize_states</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occ_country_std</span><span class="op">$</span><span class="va">occ</span>,</span>
<span>    state_column <span class="op">=</span> <span class="st">"stateProvince"</span>,</span>
<span>    country_column <span class="op">=</span> <span class="st">"country_suggested"</span>,</span>
<span>    max_distance <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    lookup_na_state <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Try to extract state from coords if value is NA</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Like <code><a href="../reference/standardize_countries.html">standardize_countries()</a></code>, the
<code><a href="../reference/standardize_states.html">standardize_states()</a></code> function returns a list with two
elements:</p>
<ul>
<li><p><code>$occ</code>: the input data frame with two new columns:
<code>state_suggested</code> (the standardized or corrected
state/province name) and <code>state_source</code> (indicates whether
the suggested state came from the original metadata or was imputed from
coordinates).</p></li>
<li><p><code>$report</code>: a summary table of the corrections and
standardizations made, showing the original name and the suggested name,
constrained by the suggested country.</p></li>
</ul>
<p>Below are the first few rows of the modified data frame and the
standardization report:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_state_std</span><span class="op">$</span><span class="va">occ</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span><span class="co">#&gt;   stateProvince state_suggested state_source country_suggested country country_source</span></span>
<span><span class="co">#&gt; 1          acre            acre     metadata            brazil  brazil       metadata</span></span>
<span><span class="co">#&gt; 2          acre            acre     metadata            brazil  brazil       metadata</span></span>
<span><span class="co">#&gt; 3          acre            acre     metadata            brazil  brazil       metadata</span></span>
<span></span>
<span><span class="va">occ_state_std</span><span class="op">$</span><span class="va">report</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;       stateProvince           state_suggested  country_suggested</span></span>
<span><span class="co">#&gt; 1        sa£o paulo                 sao paulo             brazil</span></span>
<span><span class="co">#&gt; 2         tocantins                 tocantins             brazil</span></span>
<span><span class="co">#&gt; 3               RS          rio grande do sul             brazil</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="imputing-geographic-information-from-coordinates">Imputing geographic information from coordinates<a class="anchor" aria-label="anchor" href="#imputing-geographic-information-from-coordinates"></a>
</h2>
<p>Sometimes, records have valid coordinates but lack administrative
labels entirely. We can use spatial intersection to retrieve this
information.</p>
<div class="section level3">
<h3 id="extracting-country-from-coordinates-country_from_coords">Extracting country from coordinates
(<code>country_from_coords</code>)<a class="anchor" aria-label="anchor" href="#extracting-country-from-coordinates-country_from_coords"></a>
</h3>
<p>This function uses geographic coordinates (<code>long</code>,
<code>lat</code>) and a reference world map
(<code>rnaturalearthdata::map_units110()</code>) to determine the
country for each point.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explicitly extract country from coordinates for all records</span></span>
<span><span class="va">occ_with_country_xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/country_from_coords.html">country_from_coords</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occ_state_std</span><span class="op">$</span><span class="va">occ</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"all"</span>, <span class="co"># 'all' extracts for every record; 'na_only' extracts for missing ones</span></span>
<span>    output_column <span class="op">=</span> <span class="st">"country_xy"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare the original country vs. the one derived from coordinates</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">occ_with_country_xy</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"country_xy"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   country country_xy</span></span>
<span><span class="co">#&gt; 1  brazil     brazil</span></span>
<span><span class="co">#&gt; 2  brazil     brazil</span></span>
<span><span class="co">#&gt; 3  brazil     brazil</span></span>
<span><span class="co">#&gt; 4      BR     brazil</span></span>
<span><span class="co">#&gt; 5      BR     brazil</span></span>
<span><span class="co">#&gt; 6      BR     brazil</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="extracting-state-from-coordinates-states_from_coords">Extracting state from coordinates
(<code>states_from_coords</code>)<a class="anchor" aria-label="anchor" href="#extracting-state-from-coordinates-states_from_coords"></a>
</h3>
<p>Similarly, we can extract state or province names. Here, we
demonstrate filling all records (<code>from = "all"</code>) and
appending a source column to track where the data came from.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract state from coordinates for all records</span></span>
<span><span class="va">occ_imputed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/states_from_coords.html">states_from_coords</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occ_with_country_xy</span>,</span>
<span>    from <span class="op">=</span> <span class="st">"all"</span>,</span>
<span>    state_column <span class="op">=</span> <span class="st">"stateProvince"</span>,</span>
<span>    output_column <span class="op">=</span> <span class="st">"state_xy"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">occ_imputed</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"stateProvince"</span>, <span class="st">"state_xy"</span>, <span class="st">"state_source"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   stateProvince state_xy state_source</span></span>
<span><span class="co">#&gt; 1          acre     acre     metadata</span></span>
<span><span class="co">#&gt; 2          acre     acre     metadata</span></span>
<span><span class="co">#&gt; 3          acre     acre     metadata</span></span>
<span><span class="co">#&gt; 4          acre amazonas     metadata</span></span>
<span><span class="co">#&gt; 5          acre     acre     metadata</span></span>
<span><span class="co">#&gt; 6          acre     acre     metadata</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="checking-and-fixing-spatial-inconsistencies">Checking and fixing spatial inconsistencies<a class="anchor" aria-label="anchor" href="#checking-and-fixing-spatial-inconsistencies"></a>
</h2>
<p>A critical quality control step is verifying whether the coordinates
actually fall within the administrative unit assigned to them.
Discrepancies often indicate errors in either the label or the
coordinates.</p>
<div class="section level3">
<h3 id="checking-country-consistency-check_countries">Checking country consistency (<code>check_countries</code>)<a class="anchor" aria-label="anchor" href="#checking-country-consistency-check_countries"></a>
</h3>
<p>This function compares the coordinates against the boundaries of the
country assigned in the <code>country_suggested</code> column.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check if coordinates fall within the assigned country</span></span>
<span><span class="va">occ_checked_country</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_countries.html">check_countries</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occ_imputed</span>,</span>
<span>    country_column <span class="op">=</span> <span class="st">"country_suggested"</span>,</span>
<span>    distance <span class="op">=</span> <span class="fl">5</span>,      <span class="co"># Allows a 5 km buffer for border points</span></span>
<span>    try_to_fix <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Automatically attempts to fix inverted/swapped coordinates</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Testing countries...</span></span>
<span><span class="co">#&gt; 468 records fall in wrong countries</span></span>
<span><span class="co">#&gt; Task 1 of 7: testing if longitude is inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude inverted</span></span>
<span><span class="co">#&gt; Task 2 of 7: testing if latitude is inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with latitude inverted</span></span>
<span><span class="co">#&gt; Task 3 of 7: testing if longitude and latitude are inverted</span></span>
<span><span class="co">#&gt; 2 coordinates with longitude and latitude inverted</span></span>
<span><span class="co">#&gt; Task 4 of 7: testing if longitude and latitude are swapped</span></span>
<span><span class="co">#&gt; 1 coordinates with longitude and latitude swapped</span></span>
<span><span class="co">#&gt; Task 5 of 7: testing if longitude and latitude are swapped with longitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and latitude inverted</span></span>
<span><span class="co">#&gt; Task 6 of 7: testing if longitude and latitude are swapped - with latitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and longitude inverted</span></span>
<span><span class="co">#&gt; Task 7 of 7: testing if longitude and latitude are swapped - with longitude latitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and inverted</span></span>
<span></span>
<span><span class="co"># The 'correct_country' column indicates validity</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">occ_checked_country</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country_suggested"</span>, <span class="st">"correct_country"</span>, <span class="st">"country_issues"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   country_suggested correct_country country_issues</span></span>
<span><span class="co">#&gt; 1            brazil            TRUE        correct</span></span>
<span><span class="co">#&gt; 2            brazil            TRUE        correct</span></span>
<span><span class="co">#&gt; 3            brazil            TRUE        correct</span></span>
<span><span class="co">#&gt; 4            brazil            TRUE        correct</span></span>
<span><span class="co">#&gt; 5            brazil            TRUE        correct</span></span>
<span><span class="co">#&gt; 6            brazil            TRUE        correct</span></span></code></pre></div>
<p>The column <code>correct_country</code> is added, indicating
<code>TRUE</code> if the point falls within the country. Because we set
<code>try_to_fix = TRUE</code>, the function internally calls
<code><a href="../reference/fix_countries.html">fix_countries()</a></code> to identify and correct errors like swapped
latitude/longitude, recording the action in
<code>country_issues</code>.</p>
</div>
<div class="section level3">
<h3 id="checking-state-consistency-check_states">Checking state consistency (<code>check_states</code>)<a class="anchor" aria-label="anchor" href="#checking-state-consistency-check_states"></a>
</h3>
<p>We perform a similar verification for states. Note that
<code>check_states</code> verifies points against the
<code>state_suggested</code> column.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check if coordinates fall within the assigned state</span></span>
<span><span class="va">occ_checked_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_states.html">check_states</a></span><span class="op">(</span></span>
<span>    occ <span class="op">=</span> <span class="va">occ_checked_country</span>,</span>
<span>    state_column <span class="op">=</span> <span class="st">"state_suggested"</span>,</span>
<span>    distance <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    try_to_fix <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># We just want to flag issues here, not auto-fix</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Testing states...</span></span>
<span><span class="co">#&gt; 87 records fall in wrong states</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">occ_checked_state</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state_suggested"</span>, <span class="st">"correct_state"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   state_suggested correct_state</span></span>
<span><span class="co">#&gt; 1            acre          TRUE</span></span>
<span><span class="co">#&gt; 2            acre          TRUE</span></span>
<span><span class="co">#&gt; 3            acre          TRUE</span></span>
<span><span class="co">#&gt; 4            acre         FALSE</span></span>
<span><span class="co">#&gt; 5            acre          TRUE</span></span>
<span><span class="co">#&gt; 6            acre          TRUE</span></span></code></pre></div>
<p>The <code>correct_country</code> and <code>correct_states</code>
columns represent the first set of flags: records marked as FALSE
indicate potentially erroneous entries. For additional details on how to
explore and remove flagged records, see the vignette <em>“3. Flagging
Records Using Record Information”</em>.</p>
</div>
<div class="section level3">
<h3 id="fixing-coordinate-errors-explicitly-fix_countries">Fixing coordinate errors explicitly
(<code>fix_countries</code>)<a class="anchor" aria-label="anchor" href="#fixing-coordinate-errors-explicitly-fix_countries"></a>
</h3>
<p>If you prefer to run the fixing process separately (instead of inside
<code>check_countries</code>), you can use <code><a href="../reference/fix_countries.html">fix_countries()</a></code>.
This function runs seven distinct tests to detect issues such as
inverted signs or swapped coordinates.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This step is only necessary if you did NOT set try_to_fix = TRUE above</span></span>
<span><span class="va">fixing_example</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fix_countries.html">fix_countries</a></span><span class="op">(</span></span>
<span>   occ <span class="op">=</span> <span class="va">occ_checked_country</span>,</span>
<span>   country_column <span class="op">=</span> <span class="st">"country_suggested"</span>,</span>
<span>   correct_country <span class="op">=</span> <span class="st">"correct_country"</span> <span class="co"># Column created by check_countries</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Task 1 of 7: testing if longitude is inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude inverted</span></span>
<span><span class="co">#&gt; Task 2 of 7: testing if latitude is inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with latitude inverted</span></span>
<span><span class="co">#&gt; Task 3 of 7: testing if longitude and latitude are inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude inverted</span></span>
<span><span class="co">#&gt; Task 4 of 7: testing if longitude and latitude are swapped</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped</span></span>
<span><span class="co">#&gt; Task 5 of 7: testing if longitude and latitude are swapped with longitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and latitude inverted</span></span>
<span><span class="co">#&gt; Task 6 of 7: testing if longitude and latitude are swapped - with latitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and longitude inverted</span></span>
<span><span class="co">#&gt; Task 7 of 7: testing if longitude and latitude are swapped - with longitude latitude inverted</span></span>
<span><span class="co">#&gt; 0 coordinates with longitude and latitude swapped and inverted</span></span></code></pre></div>
<p>Records identified as “inverted” or “swapped” are corrected in place,
and the <code>country_issues</code> column is updated to reflect the
specific error type found.</p>
<p>Now that we can have our dataset with the countries and states
standardized and checked, we can go to the next step: <em>3. Flagging
Records Using Associated Information”</em>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Weverton C. F. Trindade, Fernanda S. Caron.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
