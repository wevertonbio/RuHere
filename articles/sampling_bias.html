<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5. Reducing sampling bias • RuHere</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="5. Reducing sampling bias">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RuHere</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fas fa-code"></span> Functions</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/obtaining_data.html">1. Obtaining and preparing occurrence data</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_consistency.html">2. Ensuring spatial consistency</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records.html">3. Flagging Records Using Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records_species_list.html">4. Flagging Records with Specialists' Information</a></li>
    <li><a class="dropdown-item" href="../articles/sampling_bias.html">5. Reducing sampling bias</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/wevertonbio/RuHere/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>5. Reducing sampling bias</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wevertonbio/RuHere/blob/main/vignettes/sampling_bias.Rmd" class="external-link"><code>vignettes/sampling_bias.Rmd</code></a></small>
      <div class="d-none name"><code>sampling_bias.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>For most studies relying on primary biodiversity data, sampling bias
can be a problem because it creates clusters of points that reflect
accessible areas and the preferences of the researchers who collected
the data, rather than the ecological preferences of the species.</p>
<p>Two common approaches to mitigate sampling bias involve thinning
occurrence records (i.e., removing records that are close to each
other). Thinning can be performed in either geographic or environmental
space. The <code>RuHere</code> package allows the use of both approaches
and also enables combining the results of both methods.</p>
<p>As an example, let’s use the records of <em>Araucaria
angustifolia</em> available in the package, after removing records
flagged as potentially problematic:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wevertonbio.github.io/RuHere/">RuHere</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.8.93</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview" class="external-link">mapview</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Import occurrence data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"occ_flagged"</span>, package <span class="op">=</span> <span class="st">"RuHere"</span><span class="op">)</span></span>
<span><span class="co"># Remove flagged records</span></span>
<span><span class="va">occ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_flagged</span><span class="op">)</span></span>
<span><span class="co"># Plot records</span></span>
<span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/import%20data-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level2">
<h2 id="heatmap-for-occurrence-data">Heatmap for occurrence data<a class="anchor" aria-label="anchor" href="#heatmap-for-occurrence-data"></a>
</h2>
<p>Before starting the thinning process, let’s create a heatmap based on
a kernel density estimation of the records:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate heatmap</span></span>
<span><span class="va">heatmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, resolution <span class="op">=</span> <span class="fl">0.2</span>, buffer_extent <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                       radius <span class="op">=</span> <span class="fl">2</span>, zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>We can use the function <code><a href="../reference/ggmap_here.html">ggmap_here()</a></code> to plot the
occurrences and the heatmap (or use <code><a href="../reference/map_here.html">map_here()</a></code> if you
prefer an interactive version).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, size_points <span class="op">=</span> <span class="fl">0.5</span>, heatmap <span class="op">=</span> <span class="va">heatmap</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-3-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>We can observe a notable hotspot with a cluster of records around
Curitiba city (capital of Paraná, southern Brazil), which indicates
strong sampling bias. Let’s evaluate the effect of thinning these
records in geographic space.</p>
</div>
<div class="section level2">
<h2 id="thinning-in-geographic-space">Thinning in geographic space<a class="anchor" aria-label="anchor" href="#thinning-in-geographic-space"></a>
</h2>
<p>The <code><a href="../reference/thin_geo.html">thin_geo()</a></code> function flags occurrence records for
thinning by keeping only one record per species within a radius of
<code>d</code> kilometers. This function is similar to
<code>thin()</code> from the <a href="https://nsojournals.onlinelibrary.wiley.com/doi/10.1111/ecog.01132" class="external-link">spThin
package</a>, but with an important difference: it allows specifying a
priority order for retaining records.</p>
<p>When a thinning distance is provided (e.g., 10 km), the function
identifies clusters of records within that distance. Within each
cluster, it retains the record with the highest priority according to
the column defined in prioritary_column (for example, using the most
recent record when <code>prioritary_column = "year"</code>), and flags
all remaining nearby records for removal. If
<code>prioritary_column</code> is <code>NULL</code>, the priority
follows the original row order of the input occ data frame.</p>
<p>Let’s thin the records using a 10 km radius and keep the most recent
record as the priority:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Thin records using a 10 km distance threshold</span></span>
<span><span class="va">occ_thin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_geo.html">thin_geo</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, d <span class="op">=</span> <span class="fl">10</span>, prioritary_column <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">occ_thin</span><span class="op">$</span><span class="va">thin_geo_flag</span><span class="op">)</span>  <span class="co"># Number of records flagged for removal</span></span>
<span><span class="co">#&gt; [1] 1860</span></span></code></pre></div>
<p><br></p>
<p>The function flagged 1,860 records for removal. Let’s visualize the
flagged records using <code><a href="../reference/map_here.html">map_here()</a></code> and create a heatmap with
the remaining records.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove flagged records</span></span>
<span><span class="va">occ_thin_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thin</span><span class="op">)</span></span>
<span><span class="co"># Create heatmap</span></span>
<span><span class="va">heatmap_thin_geo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thin_geo</span>, resolution <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                buffer_extent <span class="op">=</span> <span class="fl">50</span>, radius <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span><span class="va">occ_thin</span>, size_points <span class="op">=</span> <span class="fl">0.5</span>, heatmap <span class="op">=</span> <span class="va">heatmap_thin_geo</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-5-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>The thinned dataset (in green) produces a more spatially uniform
heatmap and reduces the strong sampling bias around Curitiba. We explore
different distance thresholds in the next section.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="selecting-the-best-distance-to-thin-records">Selecting the best distance to thin records<a class="anchor" aria-label="anchor" href="#selecting-the-best-distance-to-thin-records"></a>
</h2>
<p>A key question is determining the optimal thinning distance, since we
rarely have sufficient biological justification for choosing a specific
value. To address this issue, we adapted the approach of <a href="https://onlinelibrary.wiley.com/doi/10.1111/ddi.13215" class="external-link">Velazco et
al. (2020)</a>, which computes spatial autocorrelation (Moran’s I) for
datasets generated using different thinning distances and selects the
distance that yields the lowest average spatial autocorrelation.</p>
<p>We extended this procedure by adjusting the selection rules to avoid
choosing datasets with too few records or unrealistically low Moran’s I
values. See <code><a href="../reference/flag_geo_moran.html">help(flag_geo_moran)</a></code> for full details of the
selection procedure.</p>
<p>As an example, let’s test the effect of thinning using distances of
1, 3, 5, 7, 10, 15, 20, and 30 km. For computing spatial correlation, we
need a raster containing the environmental variables. Here, we again
specify a priority for retaining records (the most recent ones).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load example of raster variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"worldclim"</span>, package <span class="op">=</span> <span class="st">"RuHere"</span><span class="op">)</span></span>
<span><span class="co"># Unwrap Packed raster</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/wrap.html" class="external-link">unwrap</a></span><span class="op">(</span><span class="va">worldclim</span><span class="op">)</span></span>
<span><span class="co"># Select thinned occurrences</span></span>
<span><span class="va">occ_geo_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_geo_moran.html">flag_geo_moran</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, </span>
<span>                                d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span>, </span>
<span>                                prioritary_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>                                env_layers <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; Filtering records...</span></span>
<span><span class="co">#&gt; Calculating spatial autocorrelation using Moran Index...</span></span></code></pre></div>
<p><br></p>
<p>The results for each tested distance are returned in the
<code>imoran</code> data.frame. It includes Moran’s I for each variable
and summary statistics across variables (mean, median, minimum, and
maximum), along with the number of retained records
(<code>n_filtered</code>) and the proportion of records flagged
(<code>prop_lost</code>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">imoran</span></span>
<span><span class="co">#&gt;                   species Distance      bio_1     bio_7    bio_12 median_moran</span></span>
<span><span class="co">#&gt; 1  Araucaria angustifolia        1 0.26797715 0.4154464 0.2700062    0.2700062</span></span>
<span><span class="co">#&gt; 3  Araucaria angustifolia        3 0.20037829 0.3587940 0.1982657    0.2003783</span></span>
<span><span class="co">#&gt; 5  Araucaria angustifolia        5 0.17522297 0.3368257 0.1765754    0.1765754</span></span>
<span><span class="co">#&gt; 7  Araucaria angustifolia        7 0.16065669 0.3235316 0.1695589    0.1695589</span></span>
<span><span class="co">#&gt; 10 Araucaria angustifolia       10 0.15567148 0.2954804 0.1622244    0.1622244</span></span>
<span><span class="co">#&gt; 15 Araucaria angustifolia       15 0.14275985 0.2697169 0.1536365    0.1536365</span></span>
<span><span class="co">#&gt; 20 Araucaria angustifolia       20 0.13085143 0.2802101 0.1463788    0.1463788</span></span>
<span><span class="co">#&gt; 30 Araucaria angustifolia       30 0.09891003 0.2382515 0.1634006    0.1634006</span></span>
<span><span class="co">#&gt;    mean_moran  min_moran max_moran n_filtered all_records prop_lost</span></span>
<span><span class="co">#&gt; 1   0.3178099 0.26797715 0.4154464       1236        2426 0.4905194</span></span>
<span><span class="co">#&gt; 3   0.2524793 0.19826573 0.3587940        878        2426 0.6380874</span></span>
<span><span class="co">#&gt; 5   0.2295414 0.17522297 0.3368257        732        2426 0.6982688</span></span>
<span><span class="co">#&gt; 7   0.2179157 0.16065669 0.3235316        634        2426 0.7386645</span></span>
<span><span class="co">#&gt; 10  0.2044587 0.15567148 0.2954804        517        2426 0.7868920</span></span>
<span><span class="co">#&gt; 15  0.1887044 0.14275985 0.2697169        386        2426 0.8408904</span></span>
<span><span class="co">#&gt; 20  0.1858135 0.13085143 0.2802101        313        2426 0.8709810</span></span>
<span><span class="co">#&gt; 30  0.1668540 0.09891003 0.2382515        206        2426 0.9150866</span></span></code></pre></div>
<p><br></p>
<p>The “best” distance that reduces the spatial autocorrelation without
discarding too many records was 15km. Using this threshold, 2,040
records were flagged.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Best distance selected</span></span>
<span><span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">distance</span></span>
<span><span class="co">#&gt; [1] "15"</span></span>
<span><span class="co"># Number of flagged records using this distance to thin</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">$</span><span class="va">thin_geo_flag</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2040</span></span></code></pre></div>
<p><br></p>
<p>Visual inspection shows an even more uniform heatmap:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove flagged records</span></span>
<span><span class="va">occ_thin_geo_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">)</span></span>
<span><span class="co"># Create heatmap</span></span>
<span><span class="va">heatmap_thin_geo_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thin_geo_moran</span>, </span>
<span>                                      resolution <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                      buffer_extent <span class="op">=</span> <span class="fl">50</span>, radius <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                      zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">occ</span>, size_points <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>           heatmap <span class="op">=</span> <span class="va">heatmap_thin_geo_moran</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>A potential issue when filtering records in geographic space is that
two nearby records may actually occur in distinct environmental
conditions, especially in highly heterogeneous regions. This can lead to
the loss of unique information about the species’ niche and
environmental tolerances. To address this, we can instead apply thinning
in environmental space, as explored in the next sections. <br></p>
</div>
<div class="section level2">
<h2 id="thinning-in-environmental-space">Thinning in environmental space<a class="anchor" aria-label="anchor" href="#thinning-in-environmental-space"></a>
</h2>
<p>Thinning in environmental space removes records with similar
environmental conditions, representing redundant ecological information.
This is achieved by building a multidimensional grid in environmental
space, dividing each variable into <code>n_bins</code> equally sized
intervals. Each record is assigned to a unique environmental block (a
combination of bins), and records within the same block (i.e.,
environmentally similar) are flagged for removal.</p>
<p>To illustrate how the environmental grid works, let’s use
<code><a href="../reference/get_env_bins.html">get_env_bins()</a></code> with 10 bins:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get bins</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_env_bins.html">get_env_bins</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, env_layers <span class="op">=</span> <span class="va">r</span>, n_bins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">b</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;      bio_1  bio_7 bio_12 bio_1_bin bio_7_bin bio_12_bin block_id</span></span>
<span><span class="co">#&gt; 1 17.69396 18.667   1523         5         5          3    5_5_3</span></span>
<span><span class="co">#&gt; 2 17.10746 17.701   1397         5         4          2    5_4_2</span></span>
<span><span class="co">#&gt; 3 16.44496 19.445   1698         4         6          4    4_6_4</span></span>
<span><span class="co">#&gt; 4 18.17946 22.320   1872         6         9          5    6_9_5</span></span>
<span><span class="co">#&gt; 5 19.71071 18.632   1496         7         5          3    7_5_3</span></span>
<span><span class="co">#&gt; 6 17.77913 19.411   1576         5         6          3    5_6_3</span></span></code></pre></div>
<p><br></p>
<p>The function returns the environmental block IDs for each record. We
can visualize the grid for any two variables:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="../reference/plot_env_bins.html">plot_env_bins</a></span><span class="op">(</span><span class="va">b</span>, x_var <span class="op">=</span> <span class="st">"bio_1"</span>, y_var <span class="op">=</span> <span class="st">"bio_12"</span>,</span>
<span>              xlab <span class="op">=</span> <span class="st">"Temperature"</span>, ylab <span class="op">=</span> <span class="st">"Precipitation"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>We can see that several records fall into the same block, meaning
they are environmentally similar and therefore redundant. Let’s flag
these redundant records using <code><a href="../reference/thin_env.html">thin_env()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Flag records that are close to each other in the enviromnetal space</span></span>
<span><span class="va">occ_thin_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thin_env.html">thin_env</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, env_layers <span class="op">=</span> <span class="va">r</span>, n_bins <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                         prioritary_column <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span></span>
<span><span class="co"># Number of flagged (redundant) records</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">occ_thin_env</span><span class="op">$</span><span class="va">thin_env_flag</span><span class="op">)</span> <span class="co">#Number of flagged records</span></span>
<span><span class="co">#&gt; [1] 2227</span></span></code></pre></div>
<p><br></p>
<p>The function flagged 2,227 records. Let’s visualize these and create
a heatmap of the remaining data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove flagged records</span></span>
<span><span class="va">occ_thinned_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thin_env</span><span class="op">)</span></span>
<span><span class="co"># Create heatmap</span></span>
<span><span class="va">heatmap_thin_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thinned_env</span>, resolution <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                buffer_extent <span class="op">=</span> <span class="fl">50</span>, radius <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                                zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span><span class="va">occ_thin_env</span>, size_points <span class="op">=</span> <span class="fl">0.5</span>, heatmap <span class="op">=</span> <span class="va">heatmap_thin_env</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-13-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>Thinning in environmental space produces a spatial pattern that
differs from the dataset filtered exclusively in geographic space.</p>
<p>Similar to the thinning process in geographic space, we can test
different numbers of bins (see next section).</p>
</div>
<div class="section level2">
<h2 id="selecting-the-best-number-of-environmental-bins">Selecting the best number of environmental bins<a class="anchor" aria-label="anchor" href="#selecting-the-best-number-of-environmental-bins"></a>
</h2>
<p>In geographic thinning, the key parameter is distance. In
environmental thinning, it is the number of bins. More bins result in
finer partitions of environmental space, reducing the chances of records
falling into the same block. As with geographic thinning, we can test
multiple bin values and select the one that reduces spatial
autocorrelation without discarding many records.</p>
<p>Here, we test 5, 10, 20, 30, 40, 50, 60, 70, and 80 bins:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select thinned occurrences</span></span>
<span><span class="va">occ_env_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_env_moran.html">flag_env_moran</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, </span>
<span>                                n_bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span>, <span class="fl">80</span><span class="op">)</span>, </span>
<span>                                prioritary_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>                                env_layers <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; Filtering records...</span></span>
<span><span class="co">#&gt; Calculating spatial autocorrelation using Moran Index...</span></span></code></pre></div>
<p><br></p>
<p>Again, results are returned in an imoran data frame. It includes
Moran’s I for each variable and summary statistics across variables
(mean, median, minimum, and maximum), along with the number of retained
records (<code>n_filtered</code>) and the proportion of records flagged
(<code>prop_lost</code>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">imoran</span></span>
<span><span class="co">#&gt;                   species n_bins     bio_1     bio_7    bio_12 median_moran</span></span>
<span><span class="co">#&gt; 5  Araucaria angustifolia      5 0.2401256 0.3282298 0.1749087    0.2401256</span></span>
<span><span class="co">#&gt; 10 Araucaria angustifolia     10 0.2099819 0.3770858 0.1764008    0.2099819</span></span>
<span><span class="co">#&gt; 20 Araucaria angustifolia     20 0.1762887 0.3638996 0.1923568    0.1923568</span></span>
<span><span class="co">#&gt; 30 Araucaria angustifolia     30 0.1787372 0.3657022 0.1944775    0.1944775</span></span>
<span><span class="co">#&gt; 40 Araucaria angustifolia     40 0.1903925 0.3540410 0.1927357    0.1927357</span></span>
<span><span class="co">#&gt; 50 Araucaria angustifolia     50 0.1873899 0.3515700 0.1926828    0.1926828</span></span>
<span><span class="co">#&gt; 60 Araucaria angustifolia     60 0.1839720 0.3525726 0.1930614    0.1930614</span></span>
<span><span class="co">#&gt; 70 Araucaria angustifolia     70 0.1839973 0.3561391 0.1930398    0.1930398</span></span>
<span><span class="co">#&gt; 80 Araucaria angustifolia     80 0.1865604 0.3558738 0.1934019    0.1934019</span></span>
<span><span class="co">#&gt;    mean_moran min_moran max_moran n_filtered all_records prop_lost</span></span>
<span><span class="co">#&gt; 5   0.2477547 0.1749087 0.3282298         57        2426 0.9765045</span></span>
<span><span class="co">#&gt; 10  0.2544895 0.1764008 0.3770858        199        2426 0.9179720</span></span>
<span><span class="co">#&gt; 20  0.2441817 0.1762887 0.3638996        504        2426 0.7922506</span></span>
<span><span class="co">#&gt; 30  0.2463056 0.1787372 0.3657022        658        2426 0.7287716</span></span>
<span><span class="co">#&gt; 40  0.2457231 0.1903925 0.3540410        715        2426 0.7052762</span></span>
<span><span class="co">#&gt; 50  0.2438809 0.1873899 0.3515700        748        2426 0.6916735</span></span>
<span><span class="co">#&gt; 60  0.2432020 0.1839720 0.3525726        757        2426 0.6879637</span></span>
<span><span class="co">#&gt; 70  0.2443921 0.1839973 0.3561391        767        2426 0.6838417</span></span>
<span><span class="co">#&gt; 80  0.2452787 0.1865604 0.3558738        769        2426 0.6830173</span></span></code></pre></div>
<p><br></p>
<p>The “best” number of bins that reduces the spatial autocorrelation
without discarding too many records was 70. With this threshold, 1,659
records were flagged.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Best distance selected</span></span>
<span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">n_bins</span></span>
<span><span class="co">#&gt; [1] "70"</span></span>
<span><span class="co"># Number of flagged records using this distance to thin</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">$</span><span class="va">thin_env_flag</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1659</span></span></code></pre></div>
<p><br></p>
<p>Let’s check the distribution of these records and the heatmap
generated with the unflagged records:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove flagged records</span></span>
<span><span class="va">occ_thin_env_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">)</span></span>
<span><span class="co"># Create heatmap</span></span>
<span><span class="va">heatmap_thin_env_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_thin_env_moran</span>, </span>
<span>                                      resolution <span class="op">=</span> <span class="fl">0.2</span>, </span>
<span>                                      buffer_extent <span class="op">=</span> <span class="fl">50</span>, radius <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                                      zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span>, size_points <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>           heatmap <span class="op">=</span> <span class="va">heatmap_thin_env_moran</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-17-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level2">
<h2 id="consensus-between-environmental-and-geographic-thinning">Consensus between environmental and geographic thinning<a class="anchor" aria-label="anchor" href="#consensus-between-environmental-and-geographic-thinning"></a>
</h2>
<p>Thinning in environmental space can suffer from the opposite issue of
geographic thinning: environmentally similar records may be
geographically far apart, potentially removing important information
about the species’ geographic range.</p>
<p>To address this, the <code><a href="../reference/flag_consensus.html">flag_consensus()</a></code> function can be
used to flag records only when they are redundant in both geographic and
environmental space.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Flag occurrences by thinning in geographic space</span></span>
<span><span class="va">occ_geo_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_geo_moran.html">flag_geo_moran</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>, </span>
<span>                                d <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span><span class="op">)</span>, </span>
<span>                                prioritary_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>                                env_layers <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; Filtering records...</span></span>
<span><span class="co">#&gt; Calculating spatial autocorrelation using Moran Index...</span></span>
<span></span>
<span><span class="co"># Flag occurrences by thinning in environmental space</span></span>
<span><span class="va">occ_env_moran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_env_moran.html">flag_env_moran</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_geo_moran</span><span class="op">$</span><span class="va">occ</span>, </span>
<span>                                n_bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span>, <span class="fl">60</span>, <span class="fl">70</span>, <span class="fl">80</span><span class="op">)</span>, </span>
<span>                                prioritary_column <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>                                env_layers <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt; Filtering records...</span></span>
<span><span class="co">#&gt; Calculating spatial autocorrelation using Moran Index...</span></span>
<span><span class="co"># Get consensus</span></span>
<span><span class="va">occ_consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/flag_consensus.html">flag_consensus</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span>,</span>
<span>                                flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thin_geo"</span>, <span class="st">"thin_env"</span><span class="op">)</span>,</span>
<span>                                consensus_rule <span class="op">=</span> <span class="st">"any_true"</span>,</span>
<span>                                flag_name <span class="op">=</span> <span class="st">"thin_geo_env_flag"</span><span class="op">)</span></span>
<span><span class="co"># Remove flagged</span></span>
<span><span class="va">occ_consensus_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/remove_flagged.html">remove_flagged</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_consensus</span>, flags <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                         additional_flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thin_geo_env"</span> <span class="op">=</span> <span class="st">"thin_geo_env_flag"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create heatmap</span></span>
<span><span class="va">heatmap_consensus_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_kde.html">spatial_kde</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_consensus_filtered</span>,</span>
<span>                                          resolution <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>                                          buffer_extent <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                          radius <span class="op">=</span> <span class="fl">2</span>, zero_as_NA <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p>Let’s visualize which records were flagged by geographic thinning,
environmental thinning, or both:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ggmap_here.html">ggmap_here</a></span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ_consensus</span>, </span>
<span>          flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"thin_geo"</span>, <span class="st">"thin_env"</span><span class="op">)</span>, </span>
<span>          additional_flags <span class="op">=</span> <span class="st">"thin_geo_env_flag"</span>, </span>
<span>          names_additional_flags <span class="op">=</span> <span class="st">"Thinned geo-env"</span>, </span>
<span>          col_additional_flags <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>          size_points <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>          heatmap <span class="op">=</span> <span class="va">heatmap_consensus_filtered</span><span class="op">)</span></span></code></pre></div>
<p><img src="sampling_bias_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" alt="" width="672" style="display: block; margin: auto;"><br></p>
<p>Red points indicate records thinned in geographic space; yellow
points indicate thinning in environmental space; and blue points
indicate records thinned in both.</p>
<p>Note that we retained the records flagged only in the geographic
thinning, those flagged only in the environmental thinning, and those
not flagged by either method.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Weverton C. F. Trindade, Fernanda S. Caron.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
