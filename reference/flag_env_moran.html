<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Select Environmentally Thinned Occurrences Using Moran's I Autocorrelation — flag_env_moran • RuHere</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Select Environmentally Thinned Occurrences Using Moran's I Autocorrelation — flag_env_moran"><meta name="description" content="This function evaluates multiple environmentally thinned datasets (produced
using different number of blocks) and selects the one that best balances
low spatial autocorrelation and number of retained records.
For each number of bins provided in n_bins, the function computes Moran's I
for the selected environmental variables and summarizes autocorrelation using
a chosen statistic (mean, median, minimum, or maximum). The best thinning
level is then selected according to criteria described in Details."><meta property="og:description" content="This function evaluates multiple environmentally thinned datasets (produced
using different number of blocks) and selects the one that best balances
low spatial autocorrelation and number of retained records.
For each number of bins provided in n_bins, the function computes Moran's I
for the selected environmental variables and summarizes autocorrelation using
a chosen statistic (mean, median, minimum, or maximum). The best thinning
level is then selected according to criteria described in Details."><meta property="og:image" content="https://wevertonbio.github.io/RuHere/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RuHere</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html"><span class="fa fas fa-code"></span> Functions</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true"><span class="fa fas fa-book"></span> Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/obtaining_data.html">1. Obtaining and preparing occurrence data</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_consistency.html">2. Ensuring spatial consistency</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records.html">3. Flagging Records Using Metadata</a></li>
    <li><a class="dropdown-item" href="../articles/flagging_records_species_list.html">4. Flagging Records with Specialists' Information</a></li>
    <li><a class="dropdown-item" href="../articles/sampling_bias.html">5. Reducing sampling bias</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/wevertonbio/RuHere/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Select Environmentally Thinned Occurrences Using Moran's I Autocorrelation</h1>
      <small class="dont-index">Source: <a href="https://github.com/wevertonbio/RuHere/blob/main/R/flag_env_moran.R" class="external-link"><code>R/flag_env_moran.R</code></a></small>
      <div class="d-none name"><code>flag_env_moran.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function evaluates multiple environmentally thinned datasets (produced
using different number of blocks) and selects the one that best balances
<strong>low spatial autocorrelation</strong> and <strong>number of retained records</strong>.</p>
<p>For each number of bins provided in <code>n_bins</code>, the function computes Moran's I
for the selected environmental variables and summarizes autocorrelation using
a chosen statistic (mean, median, minimum, or maximum). The best thinning
level is then selected according to criteria described in <em>Details</em>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">flag_env_moran</span><span class="op">(</span></span>
<span>  <span class="va">occ</span>,</span>
<span>  species <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  long <span class="op">=</span> <span class="st">"decimalLongitude"</span>,</span>
<span>  lat <span class="op">=</span> <span class="st">"decimalLatitude"</span>,</span>
<span>  <span class="va">env_layers</span>,</span>
<span>  <span class="va">n_bins</span>,</span>
<span>  distance <span class="op">=</span> <span class="st">"haversine"</span>,</span>
<span>  moran_summary <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  min_records <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  min_imoran <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  prioritary_column <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  decreasing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  do_pca <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  mask <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  pca_buffer <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  flag_for_NA <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  return_all <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-occ">occ<a class="anchor" aria-label="anchor" href="#arg-occ"></a></dt>
<dd><p>(data.frame or data.table) a data frame containing the occurrence
records for a <strong>single species</strong>. Must contain columns for species, longitude,
and latitude.</p></dd>


<dt id="arg-species">species<a class="anchor" aria-label="anchor" href="#arg-species"></a></dt>
<dd><p>(character) the name of the column in <code>occ</code> that contains the
species scientific names. Default is <code>"species"</code>.</p></dd>


<dt id="arg-long">long<a class="anchor" aria-label="anchor" href="#arg-long"></a></dt>
<dd><p>(character) the name of the column in <code>occ</code> that contains the
longitude values. Default is <code>"decimalLongitude"</code>.</p></dd>


<dt id="arg-lat">lat<a class="anchor" aria-label="anchor" href="#arg-lat"></a></dt>
<dd><p>(character) the name of the column in <code>occ</code> that contains the
latitude values. Default is <code>"decimalLatitude"</code>.</p></dd>


<dt id="arg-env-layers">env_layers<a class="anchor" aria-label="anchor" href="#arg-env-layers"></a></dt>
<dd><p>(SpatRaster) object containing environmental variables for
splitting in <code>n_bins</code> and for computing Moran's I.</p></dd>


<dt id="arg-n-bins">n_bins<a class="anchor" aria-label="anchor" href="#arg-n-bins"></a></dt>
<dd><p>(numeric) vector of number of bins into which each
environmental variable will be divided (e.g., c(5, 10, 15, 20)).</p></dd>


<dt id="arg-distance">distance<a class="anchor" aria-label="anchor" href="#arg-distance"></a></dt>
<dd><p>(character) distance metric used to compute the weight matrix
for Moran's I. One of <code>"haversine"</code> or <code>"euclidean"</code>. Default: <code>"haversine"</code>.</p></dd>


<dt id="arg-moran-summary">moran_summary<a class="anchor" aria-label="anchor" href="#arg-moran-summary"></a></dt>
<dd><p>(character) summary statistic used to select the best
thinning distance. One of <code>"mean"</code>, <code>"median"</code>, <code>"max"</code>, or <code>"min"</code>.
Default: <code>"mean"</code>.</p></dd>


<dt id="arg-min-records">min_records<a class="anchor" aria-label="anchor" href="#arg-min-records"></a></dt>
<dd><p>(numeric) minimum number of records required for a dataset
to be considered. Default: <code>10</code>.</p></dd>


<dt id="arg-min-imoran">min_imoran<a class="anchor" aria-label="anchor" href="#arg-min-imoran"></a></dt>
<dd><p>(numeric) minimum Moran's I required to avoid selecting
datasets with extremely low spatial autocorrelation. Default: <code>0.1</code>.</p></dd>


<dt id="arg-prioritary-column">prioritary_column<a class="anchor" aria-label="anchor" href="#arg-prioritary-column"></a></dt>
<dd><p>(character) name of a numeric columns in <code>occ</code>to
define retention priority (e.g., quality score, year). See details.</p></dd>


<dt id="arg-decreasing">decreasing<a class="anchor" aria-label="anchor" href="#arg-decreasing"></a></dt>
<dd><p>(logical) whether to sort records in decreasing order using
the <code>prioritary_column</code> (e.g., from most recent to oldest when the variable
is <code>"year"</code>). Only applicable when <code>prioritary_column</code> is not <code>NULL</code>.
Default is <code>TRUE</code>.</p></dd>


<dt id="arg-do-pca">do_pca<a class="anchor" aria-label="anchor" href="#arg-do-pca"></a></dt>
<dd><p>(logical) whether environmental variables should be summarized
using PCA before computing Moran's I. Default: <code>FALSE</code>. See details.</p></dd>


<dt id="arg-mask">mask<a class="anchor" aria-label="anchor" href="#arg-mask"></a></dt>
<dd><p>(SpatVector or SpatExtent) optional spatial object to mask the
<code>env_layers</code> before computing PCA. Only applicable if <code>do_pca = TRUE</code>.
Default is NULL.</p></dd>


<dt id="arg-pca-buffer">pca_buffer<a class="anchor" aria-label="anchor" href="#arg-pca-buffer"></a></dt>
<dd><p>(numeric) buffer width (km) used when PCA is computed from
the convex hull of records. Ignored if <code>mask</code> is provided. Default: <code>1000</code>.</p></dd>


<dt id="arg-flag-for-na">flag_for_NA<a class="anchor" aria-label="anchor" href="#arg-flag-for-na"></a></dt>
<dd><p>(logical) whether to treat records falling in <code>NA</code> cells
of <code>env_layers</code> as valid (<code>TRUE</code>) or invalid (<code>FALSE</code>). Default is <code>FALSE</code>.</p></dd>


<dt id="arg-return-all">return_all<a class="anchor" aria-label="anchor" href="#arg-return-all"></a></dt>
<dd><p>(logical) whether to return the full list of all thinned
datasets. Default is <code>FALSE</code>.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>(logical) whether to print messages about the progress.
Default is <code>TRUE</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list with:</p><ul><li><p><strong>occ</strong>: the selected thinned occurrence dataset with the column
<code>thin_env_flag</code>indicating whether each record is retained (<code>TRUE</code>) or flagged
as redundant (<code>FALSE</code>) in the environmental space .</p></li>
<li><p><strong>imoran</strong>: a table summarizing Moran's I for each thinning distance</p></li>
<li><p><strong>n_bins</strong>: the number of bins that produced the selected dataset</p></li>
<li><p><strong>moran_summary</strong>: the summary statistic used to select the dataset</p></li>
<li><p><strong>all_thined</strong>: (optional) list of thinned datasets for all bin numbers.
Only returned if <code>return_all</code> was set to <code>TRUE</code></p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This function is inspired by the approach used in Velazco et al. (2020),
extending the procedure by allowing:</p><ul><li><p>prioritization of records based on a user-defined variable (e.g., year)</p></li>
<li><p>optional PCA transformation of environmental layers</p></li>
<li><p>selection rules that prevent datasets with too few records or extremely
low Moran's I from being chosen.</p></li>
</ul><p><strong>Procedure overview</strong></p><ol><li><p>For each bin number in <code>n_bins</code>, generate a spatially thinned dataset
using <code><a href="thin_env.html">thin_env()</a></code> function.</p></li>
<li><p>Extract environmental values for the retained records.</p></li>
<li><p>Compute Moran's I for each environmental variable.</p></li>
<li><p>Summarize autocorrelation per dataset (mean, median, min, or max).</p></li>
<li><p>Apply the selection criteria:</p><ul><li><p>Keep only datasets with at least <code>min_records</code> records.</p></li>
<li><p>Keep only datasets with Moran's I greater or equal to <code>min_imoran</code>.</p></li>
<li><p>Round Moran's I to two decimal places and select the dataset with the
<strong>25th lowest</strong> autocorrelation.</p></li>
<li><p>If more than on dataset is selected, choose the dataset retaining
<strong>more records</strong>.</p></li>
<li><p>If still tied, choose the dataset with the <strong>largest number of bins</strong>.</p></li>
</ul></li>
</ol><p><strong>Distance matrix for Moran's I</strong>
Moran's I requires a weight matrix derived from pairwise distances among
records. Two distance types are available:</p><ul><li><p><code>"haversine"</code>: geographic distance computed with <code><a href="https://rdrr.io/pkg/fields/man/rdist.earth.html" class="external-link">fields::rdist.earth()</a></code>
(default; recommended for longitude/latitude coordinates)</p></li>
<li><p><code>"euclidean"</code>: Euclidean distance computed with <code><a href="https://rdrr.io/r/stats/dist.html" class="external-link">stats::dist()</a></code></p></li>
</ul><p><strong>Environmental PCA (optional)</strong>
If <code>do_pca = TRUE</code>, the environmental layers are summarized using PCA before
Moran's I is computed.</p><ul><li><p>If <code>mask</code> is provided, PCA is computed on masked layers.</p></li>
<li><p>Otherwise, a convex hull around the records is buffered by <code>pca_buffer</code>
kilometers to define the PCA area.</p></li>
<li><p>It will select the axis that together explain more than 90% of the
variation.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Load example data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"occurrences"</span>, package <span class="op">=</span> <span class="st">"RuHere"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Subset occurrences from Araucaria</span></span></span>
<span class="r-in"><span><span class="va">occ</span> <span class="op">&lt;-</span> <span class="va">occurrences</span><span class="op">[</span><span class="va">occurrences</span><span class="op">$</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Araucaria angustifolia"</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="co"># Load example of raster variables</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"worldclim"</span>, package <span class="op">=</span> <span class="st">"RuHere"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Unwrap Packed raster</span></span></span>
<span class="r-in"><span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/wrap.html" class="external-link">unwrap</a></span><span class="op">(</span><span class="va">worldclim</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Select thinned occurrences</span></span></span>
<span class="r-in"><span><span class="va">occ_env_moran</span> <span class="op">&lt;-</span> <span class="fu">flag_env_moran</span><span class="op">(</span>occ <span class="op">=</span> <span class="va">occ</span>,</span></span>
<span class="r-in"><span>                                  n_bins <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span>, <span class="fl">50</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                  env_layers <span class="op">=</span> <span class="va">r</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Filtering records...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Calculating spatial autocorrelation using Moran Index...</span>
<span class="r-in"><span><span class="co"># Selected number of bins</span></span></span>
<span class="r-in"><span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">n_bins</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "50"</span>
<span class="r-in"><span><span class="co"># Number of flagged and unflagged records</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">$</span><span class="va">thin_env_flag</span><span class="op">)</span> <span class="co">#Retained</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 691</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">occ</span><span class="op">$</span><span class="va">thin_env_flag</span><span class="op">)</span> <span class="co">#Flagged for thinning out</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 233</span>
<span class="r-in"><span><span class="co"># Results os the spatial autocorrelation analysis</span></span></span>
<span class="r-in"><span><span class="va">occ_env_moran</span><span class="op">$</span><span class="va">imoran</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                   species n_bins     bio_1     bio_7    bio_12 median_moran</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5  Araucaria angustifolia      5 0.2443818 0.3288289 0.1647230    0.2443818</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10 Araucaria angustifolia     10 0.2093983 0.3634131 0.1693231    0.2093983</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20 Araucaria angustifolia     20 0.1655434 0.3455124 0.1727638    0.1727638</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 30 Araucaria angustifolia     30 0.1723510 0.3503620 0.1751458    0.1751458</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 40 Araucaria angustifolia     40 0.1716318 0.3369794 0.1716155    0.1716318</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 50 Araucaria angustifolia     50 0.1681880 0.3367401 0.1750636    0.1750636</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    mean_moran min_moran max_moran n_filtered all_records prop_lost</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5   0.2459779 0.1647230 0.3288289         57         924 0.9383117</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10  0.2473782 0.1693231 0.3634131        197         924 0.7867965</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20  0.2279399 0.1655434 0.3455124        478         924 0.4826840</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 30  0.2326196 0.1723510 0.3503620        617         924 0.3322511</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 40  0.2267422 0.1716155 0.3369794        660         924 0.2857143</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 50  0.2266639 0.1681880 0.3367401        691         924 0.2521645</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Weverton C. F. Trindade, Fernanda S. Caron.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

